<!DOCTYPE html>
<html lang="es" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Modo Repartidor üõµ</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">
    <style>
        body { 
            height: 100vh; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            background-color: #212529; 
            color: white;
        }
        .driver-card {
            width: 100%;
            max-width: 400px;
            padding: 2rem;
            background: #2c3034;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            text-align: center;
        }
        .status-dot {
            height: 15px; width: 15px; 
            background-color: #dc3545; 
            border-radius: 50%; 
            display: inline-block;
            box-shadow: 0 0 10px #dc3545;
        }
        .status-dot.active {
            background-color: #198754;
            box-shadow: 0 0 10px #198754;
            animation: blink 1s infinite;
        }
        @keyframes blink { 50% { opacity: 0.5; } }
    </style>
</head>
<body>

    <div class="driver-card">
        <i class="bi bi-scooter text-warning display-1 mb-3"></i>
        <h2 class="fw-bold mb-1">Modo Repartidor</h2>
        <p class="text-muted small mb-4">Emisor de Se√±al GPS</p>

        <div class="mb-4 text-start">
            <label class="form-label small text-uppercase fw-bold text-muted">C√≥digo de Rastreo (GUID)</label>
            <input type="text" id="track-code" class="form-control form-control-lg text-center fw-bold bg-dark text-white border-secondary" placeholder="Pegar c√≥digo aqu√≠...">
        </div>

        <button id="btn-start" class="btn btn-success w-100 py-3 fw-bold rounded-pill mb-4" onclick="startSharing()">
            <i class="bi bi-broadcast"></i> INICIAR VIAJE
        </button>

        <div class="card bg-dark border-secondary">
            <div class="card-body p-2 d-flex justify-content-between align-items-center">
                <span class="small text-muted">Estado:</span>
                <div class="d-flex align-items-center gap-2">
                    <span id="status-text" class="small fw-bold text-secondary">Desconectado</span>
                    <div id="status-indicator" class="status-dot"></div>
                </div>
            </div>
            <div class="card-footer border-secondary p-1 bg-black bg-opacity-25">
                <small id="log" class="text-muted" style="font-size: 0.7rem; font-family: monospace;">Esperando...</small>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/8.0.0/signalr.min.js"></script>
    
    <script type="module">
        import { initSignalR, connection } from './js/apiService.js';

        let watchId = null;

        // üî• L√ìGICA DE AUTO-RELLENADO DESDE URL
        document.addEventListener('DOMContentLoaded', () => {
            const params = new URLSearchParams(window.location.search);
            const codeFromUrl = params.get('code');
            
            // Si hay c√≥digo en la URL, lo ponemos en el input autom√°ticamente
            if (codeFromUrl) {
                const input = document.getElementById('track-code');
                if(input) input.value = codeFromUrl;
            }
        });

        window.startSharing = async () => {
            const codeInput = document.getElementById('track-code');
            const code = codeInput.value.trim();
            
            if(!code) return alert("‚ö†Ô∏è Debes pegar el c√≥digo del pedido primero.");

            const btn = document.getElementById('btn-start');
            const statusText = document.getElementById('status-text');
            const statusDot = document.getElementById('status-indicator');
            const log = document.getElementById('log');

            // Bloquear bot√≥n para evitar doble clic
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Conectando...';

            try {
                // 1. Conectar al Servidor
                await initSignalR();
                
                // 2. Cambiar UI a "En Vivo"
                btn.innerHTML = '<i class="bi bi-stop-circle"></i> DETENER VIAJE';
                btn.classList.replace('btn-success', 'btn-danger');
                btn.onclick = () => window.location.reload(); // Recargar para detener
                btn.disabled = false;
                
                statusText.textContent = "EN VIVO";
                statusText.className = "small fw-bold text-success";
                statusDot.classList.add('active');
                codeInput.disabled = true; // Bloquear input para que no lo cambien

                // 3. Obtener Ubicaci√≥n Continua
                if ("geolocation" in navigator) {
                    
                    const geoOptions = {
                        enableHighAccuracy: true, 
                        maximumAge: 0, 
                        timeout: 10000 
                    };

                    watchId = navigator.geolocation.watchPosition(async (pos) => {
                        const { latitude, longitude, speed } = pos.coords;
                        
                        log.innerHTML = `Lat: ${latitude.toFixed(5)} | Lng: ${longitude.toFixed(5)}<br>Vel: ${(speed || 0).toFixed(1)} m/s`;
                        
                        // Enviar al Servidor (SignalR)
                        try {
                            // Este m√©todo debe coincidir con el Hub en C#
                            await connection.invoke("SendDriverLocation", code, latitude, longitude);
                        } catch(err) {
                            console.error("Error env√≠o:", err);
                            log.textContent = "Error de conexi√≥n (reintentando)...";
                        }

                    }, (err) => {
                        console.warn('ERROR(' + err.code + '): ' + err.message);
                        log.textContent = "‚ö†Ô∏è Error GPS: " + err.message;
                    }, geoOptions);

                } else {
                    alert("‚ùå Tu navegador no soporta GPS.");
                    window.location.reload();
                }

            } catch (e) {
                alert("Error de conexi√≥n: " + e.message);
                btn.disabled = false;
                btn.textContent = "Reintentar";
                btn.classList.replace('btn-danger', 'btn-success');
            }
        };
    </script>
</body>
</html>